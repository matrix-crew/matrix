appId: com.matrix.app
productName: Matrix
copyright: Copyright Â© 2026 Matrix
artifactName: '${productName}-${version}-${arch}.${ext}'

# node-pty is already rebuilt by postinstall (electron-rebuild -f -w node-pty)
# Disable electron-builder's own rebuild to avoid distutils issues on Python 3.12+
npmRebuild: false
asar: true
asarUnpack:
  - '**/node_modules/node-pty/**/*'

directories:
  output: dist
  buildResources: resources

# Only include built output + runtime node_modules
# electron-vite bundles everything except externalized deps (node-pty, python-shell)
files:
  - out/**/*
  - package.json
  - node_modules/node-pty/**/*
  - node_modules/python-shell/**/*
  - node_modules/nan/**/*
  # Exclude everything else in node_modules
  - '!node_modules/@matrix/**'
  - '!**/node_modules/*/{CHANGELOG.md,README.md,README,readme.md,readme}'
  - '!**/node_modules/.bin'

# Backend source (shared across all platforms)
extraResources:
  - from: ../../apps/backend
    to: backend
    filter:
      - 'src/**/*'
      - 'pyproject.toml'
      - 'uv.lock'
      - '!**/__pycache__'
      - '!**/*.pyc'
      - '!tests/**'
      - '!.venv/**'

# macOS
mac:
  category: public.app-category.developer-tools
  target:
    - target: dmg
      arch: [arm64]
    - target: zip
      arch: [arm64]
  # icon: resources/icon.icns  # Add app icon here
  hardenedRuntime: false
  gatekeeperAssess: false
  # Code signing: uncomment when ready
  # identity: "Developer ID Application: Your Name (TEAM_ID)"
  extraResources:
    - from: resources/python/darwin-${arch}
      to: python
    - from: resources/uv/darwin-${arch}
      to: uv

dmg:
  sign: false
  contents:
    - x: 410
      y: 150
      type: link
      path: /Applications
    - x: 130
      y: 150
      type: file

# Windows
win:
  target:
    - target: nsis
      arch: [x64]
  # icon: resources/icon.ico  # Add app icon here
  # Code signing: uncomment when ready
  # certificateFile: path/to/cert.pfx
  # certificatePassword: ${env.WINDOWS_CERT_PASSWORD}
  extraResources:
    - from: resources/python/win32-${arch}
      to: python
    - from: resources/uv/win32-${arch}
      to: uv

nsis:
  oneClick: true
  perMachine: false
  allowToChangeInstallationDirectory: false
  createDesktopShortcut: true
  createStartMenuShortcut: true
  shortcutName: Matrix

# Linux
linux:
  target:
    - target: AppImage
      arch: [x64]
    - target: deb
      arch: [x64]
  category: Development
  maintainer: thearchitect9927@gmail.com
  # icon: resources/icon.png  # Add app icon here (512x512 PNG)
  extraResources:
    - from: resources/python/linux-${arch}
      to: python
    - from: resources/uv/linux-${arch}
      to: uv

appImage:
  license: null

# GitHub Releases
publish:
  provider: github
  owner: matrix-crew
  repo: matrix
